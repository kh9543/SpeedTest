<!DOCTYPE html>
<html>
<head>
<title>Speed test</title>
<meta charset="utf-8">
<script type="text/javascript">
function upload() {
  s = document.getElementById('u_s').value;
  if (s >= 200) s = 200;
  console.log("Start upload");
  var xhr = new XMLHttpRequest();
  var url = "./server/?module=upload";
  var size = s * 1024 * 1024; //s'MB
  var buffer = new ArrayBuffer(size);
  var int8View = new Int8Array(buffer);
  var blob = new Blob([int8View], {type: "application/octet-stream"});
  xhr.open('POST', url, true);
  xhr.setRequestHeader("Content-Type", "application/octet-stream")
  xhr.send(blob);
  var startTime = new Date().getTime();
  xhr.onreadystatechange = processUploadRequest;
  function processUploadRequest() {
    if(xhr.readyState == 4 && xhr.status == 200) {
      var endTime = new Date().getTime();
      var elapsedTime = endTime - startTime;
      var uploadSpeed = (s*8/(elapsedTime/1000));
      console.log(uploadSpeed);
      console.log(elapsedTime);
      createResult("upload", uploadSpeed);
    }
  }
}
// Creating Dowload Speed Test request to server
function download() {
  s = document.getElementById('d_s').value;
  if (s >= 200) s = 200;
  console.log("Start download");
  var xhr = new XMLHttpRequest();
  var url = "./server/";
  var params = "module=download&size="
  var size = s * 1024 *1024; // s'MB
  xhr.open('GET', url+"?"+params+size, true);
  //console.log(xhr);
  xhr.send();
  var startTime = new Date().getTime();
  //event listener for http request
  xhr.onreadystatechange = processDownloadRequest;
  function processDownloadRequest() {
    //msg received 
    if (xhr.readyState == 4 && xhr.status == 200 ){
      var endTime = new Date().getTime();
      var elapsedTime = endTime - startTime; //ms
      var downloadSpeed = (s*8/(elapsedTime/1000));
      console.log(downloadSpeed);
      console.log(elapsedTime);
      //document.getElementById('res').innerHTML = downloadSpeed;
      createResult("download", downloadSpeed);
    }
  }
}

function createResult(type, num) {
  var newTr = document.createElement("tr");
  var newTh_D = document.createElement("th");
  var newTh_U = document.createElement("th");
  if (type == "download") {
    newTh_D.innerHTML = num;
    newTh_U.innerHTML = ""; 
  }
  else if (type == "upload") {
    newTh_D.innerHTML = "";
    newTh_U.innerHTML = num;  
  }
  else 
    return;
  newTr.appendChild(newTh_D);
  newTr.appendChild(newTh_U);
  document.getElementById('res').appendChild(newTr);
}
</script>
<style>
table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
}
</style>
</head>
<body>
  <div>
    <span>下載大小(MB)：<input id="d_s" type="number" min="0" max="200" value="4"></span> 
    <button type="button" onclick="download(40)"> Download Test </button>
  </div>
  <div>
    <span>上傳大小(MB)：<input id="u_s" type="number" min="0" max="200" value="4"></span>
    <button type="button" onclick="upload(20)"> Upload Test </button>
  </div>
  <div style="margin:0px auto;">
    <table id="res" style="width:70%">
      <tr>
        <th> Download (Mbps)</th>
        <th> Upload (Mbps)</th>
      </tr>
    </table>
  </div>
</body>
</html>
